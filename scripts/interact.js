var fs = require('fs')

async function main() {

  const LOB_abi = JSON.parse(fs.readFileSync('./artifacts/contracts/LimitOrderBook.sol/LimitOrderBook.json')).abi

  const SWF_abi = JSON.parse(fs.readFileSync('./artifacts/contracts/SmartWallet.sol/SmartWalletFactory.json')).abi

  const SW_abi = JSON.parse(fs.readFileSync('./artifacts/contracts/SmartWallet.sol/SmartWallet.json')).abi

  const CH_abi = [{"type":"event","name":"LiquidationFeeRatioChanged","inputs":[{"type":"uint256","name":"liquidationFeeRatio","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"MarginChanged","inputs":[{"type":"address","name":"sender","internalType":"address","indexed":true},{"type":"address","name":"amm","internalType":"address","indexed":true},{"type":"int256","name":"amount","internalType":"int256","indexed":false},{"type":"int256","name":"fundingPayment","internalType":"int256","indexed":false}],"anonymous":false},{"type":"event","name":"MarginRatioChanged","inputs":[{"type":"uint256","name":"marginRatio","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"type":"address","name":"previousOwner","internalType":"address","indexed":true},{"type":"address","name":"newOwner","internalType":"address","indexed":true}],"anonymous":false},{"type":"event","name":"Paused","inputs":[{"type":"address","name":"account","internalType":"address","indexed":false}],"anonymous":false},{"type":"event","name":"PositionAdjusted","inputs":[{"type":"address","name":"amm","internalType":"address","indexed":true},{"type":"address","name":"trader","internalType":"address","indexed":true},{"type":"int256","name":"newPositionSize","internalType":"int256","indexed":false},{"type":"uint256","name":"oldLiquidityIndex","internalType":"uint256","indexed":false},{"type":"uint256","name":"newLiquidityIndex","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"PositionChanged","inputs":[{"type":"address","name":"trader","internalType":"address","indexed":true},{"type":"address","name":"amm","internalType":"address","indexed":true},{"type":"uint256","name":"margin","internalType":"uint256","indexed":false},{"type":"uint256","name":"positionNotional","internalType":"uint256","indexed":false},{"type":"int256","name":"exchangedPositionSize","internalType":"int256","indexed":false},{"type":"uint256","name":"fee","internalType":"uint256","indexed":false},{"type":"int256","name":"positionSizeAfter","internalType":"int256","indexed":false},{"type":"int256","name":"realizedPnl","internalType":"int256","indexed":false},{"type":"int256","name":"unrealizedPnlAfter","internalType":"int256","indexed":false},{"type":"uint256","name":"badDebt","internalType":"uint256","indexed":false},{"type":"uint256","name":"liquidationPenalty","internalType":"uint256","indexed":false},{"type":"uint256","name":"spotPrice","internalType":"uint256","indexed":false},{"type":"int256","name":"fundingPayment","internalType":"int256","indexed":false}],"anonymous":false},{"type":"event","name":"PositionLiquidated","inputs":[{"type":"address","name":"trader","internalType":"address","indexed":true},{"type":"address","name":"amm","internalType":"address","indexed":true},{"type":"uint256","name":"positionNotional","internalType":"uint256","indexed":false},{"type":"uint256","name":"positionSize","internalType":"uint256","indexed":false},{"type":"uint256","name":"liquidationFee","internalType":"uint256","indexed":false},{"type":"address","name":"liquidator","internalType":"address","indexed":false},{"type":"uint256","name":"badDebt","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"PositionSettled","inputs":[{"type":"address","name":"amm","internalType":"address","indexed":true},{"type":"address","name":"trader","internalType":"address","indexed":true},{"type":"uint256","name":"valueTransferred","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"RestrictionModeEntered","inputs":[{"type":"address","name":"amm","internalType":"address","indexed":false},{"type":"uint256","name":"blockNumber","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"Unpaused","inputs":[{"type":"address","name":"account","internalType":"address","indexed":false}],"anonymous":false},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"addMargin","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"tuple","name":"_addedMargin","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"adjustPosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"candidate","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"closePosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"tuple","name":"_quoteAssetAmountLimit","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"contract IMultiTokenRewardRecipient"}],"name":"feePool","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getLatestCumulativePremiumFraction","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getMarginRatio","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"address","name":"_trader","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct ClearingHouse.Position","components":[{"type":"tuple","name":"size","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"tuple","name":"margin","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"openNotional","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"lastUpdatedCumulativePremiumFraction","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"uint256","name":"liquidityHistoryIndex","internalType":"uint256"},{"type":"uint256","name":"blockNumber","internalType":"uint256"}]}],"name":"getPosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"address","name":"_trader","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"positionNotional","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"unrealizedPnl","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getPositionNotionalAndUnrealizedPnl","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"address","name":"_trader","internalType":"address"},{"type":"uint8","name":"_pnlCalcOption","internalType":"enum ClearingHouse.PnlCalcOption"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"position","internalType":"struct ClearingHouse.Position","components":[{"type":"tuple","name":"size","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"tuple","name":"margin","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"openNotional","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"lastUpdatedCumulativePremiumFraction","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"uint256","name":"liquidityHistoryIndex","internalType":"uint256"},{"type":"uint256","name":"blockNumber","internalType":"uint256"}]}],"name":"getUnadjustedPosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"address","name":"_trader","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"initMarginRatio","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"initialize","inputs":[{"type":"uint256","name":"_initMarginRatio","internalType":"uint256"},{"type":"uint256","name":"_maintenanceMarginRatio","internalType":"uint256"},{"type":"uint256","name":"_liquidationFeeRatio","internalType":"uint256"},{"type":"address","name":"_insuranceFund","internalType":"contract IInsuranceFund"},{"type":"address","name":"_trustedForwarder","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"contract IInsuranceFund"}],"name":"insuranceFund","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bool","name":"","internalType":"bool"}],"name":"isTrustedForwarder","inputs":[{"type":"address","name":"forwarder","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"liquidate","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"address","name":"_trader","internalType":"address"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"liquidationFeeRatio","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"maintenanceMarginRatio","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"openInterestNotionalMap","inputs":[{"type":"address","name":"","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"openPosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"uint8","name":"_side","internalType":"enum ClearingHouse.Side"},{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_leverage","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_baseAssetAmountLimit","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"owner","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"pause","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bool","name":"","internalType":"bool"}],"name":"paused","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"payFunding","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"removeMargin","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"},{"type":"tuple","name":"_removedMargin","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"renounceOwnership","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setFeePool","inputs":[{"type":"address","name":"_feePool","internalType":"contract IMultiTokenRewardRecipient"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setLiquidationFeeRatio","inputs":[{"type":"tuple","name":"_liquidationFeeRatio","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setMaintenanceMarginRatio","inputs":[{"type":"tuple","name":"_maintenanceMarginRatio","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setOwner","inputs":[{"type":"address","name":"newOwner","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setWhitelist","inputs":[{"type":"address","name":"_whitelist","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"settlePosition","inputs":[{"type":"address","name":"_amm","internalType":"contract IAmm"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"trustedForwarder","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"unpause","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"updateOwner","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"string","name":"","internalType":"string"}],"name":"versionRecipient","inputs":[]}]

  const AMM_abi = [{"type":"event","name":"CapChanged","inputs":[{"type":"uint256","name":"maxHoldingBaseAsset","internalType":"uint256","indexed":false},{"type":"uint256","name":"openInterestNotionalCap","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"FundingRateUpdated","inputs":[{"type":"int256","name":"rate","internalType":"int256","indexed":false},{"type":"uint256","name":"underlyingPrice","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"LiquidityChanged","inputs":[{"type":"uint256","name":"quoteReserve","internalType":"uint256","indexed":false},{"type":"uint256","name":"baseReserve","internalType":"uint256","indexed":false},{"type":"int256","name":"cumulativeNotional","internalType":"int256","indexed":false}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"type":"address","name":"previousOwner","internalType":"address","indexed":true},{"type":"address","name":"newOwner","internalType":"address","indexed":true}],"anonymous":false},{"type":"event","name":"ReserveSnapshotted","inputs":[{"type":"uint256","name":"quoteAssetReserve","internalType":"uint256","indexed":false},{"type":"uint256","name":"baseAssetReserve","internalType":"uint256","indexed":false},{"type":"uint256","name":"timestamp","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"Shutdown","inputs":[{"type":"uint256","name":"settlementPrice","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"SwapInput","inputs":[{"type":"uint8","name":"dir","internalType":"enum IAmm.Dir","indexed":false},{"type":"uint256","name":"quoteAssetAmount","internalType":"uint256","indexed":false},{"type":"uint256","name":"baseAssetAmount","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"event","name":"SwapOutput","inputs":[{"type":"uint8","name":"dir","internalType":"enum IAmm.Dir","indexed":false},{"type":"uint256","name":"quoteAssetAmount","internalType":"uint256","indexed":false},{"type":"uint256","name":"baseAssetAmount","internalType":"uint256","indexed":false}],"anonymous":false},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"baseAssetReserve","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"calcBaseAssetAfterLiquidityMigration","inputs":[{"type":"tuple","name":"_baseAssetAmount","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"tuple","name":"_fromQuoteReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_fromBaseReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"calcFee","inputs":[{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"candidate","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"fluctuationLimitRatio","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"fundingBufferPeriod","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"fundingPeriod","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"int256","name":"d","internalType":"int256"}],"name":"fundingRate","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getBaseAssetDelta","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getBaseAssetDeltaThisFundingPeriod","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"getCumulativeNotional","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getInputPrice","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"pure","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getInputPriceWithReserves","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_quoteAssetPoolAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_baseAssetPoolAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getInputTwap","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct IAmm.LiquidityChangedSnapshot","components":[{"type":"tuple","name":"cumulativeNotional","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"tuple","name":"quoteAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"baseAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"totalPositionSize","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}]}],"name":"getLatestLiquidityChangedSnapshots","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct IAmm.LiquidityChangedSnapshot","components":[{"type":"tuple","name":"cumulativeNotional","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]},{"type":"tuple","name":"quoteAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"baseAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"totalPositionSize","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}]}],"name":"getLiquidityChangedSnapshots","inputs":[{"type":"uint256","name":"i","internalType":"uint256"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"getLiquidityHistoryLength","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getMaxHoldingBaseAsset","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getOpenInterestNotionalCap","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getOutputPrice","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_baseAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"pure","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getOutputPriceWithReserves","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_baseAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_quoteAssetPoolAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_baseAssetPoolAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getOutputTwap","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_baseAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getReserve","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getSettlementPrice","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"getSnapshotLen","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getSpotPrice","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getTwapPrice","inputs":[{"type":"uint256","name":"_intervalInSeconds","internalType":"uint256"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getUnderlyingPrice","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"getUnderlyingTwapPrice","inputs":[{"type":"uint256","name":"_intervalInSeconds","internalType":"uint256"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"globalShutdown","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"initialize","inputs":[{"type":"uint256","name":"_quoteAssetReserve","internalType":"uint256"},{"type":"uint256","name":"_baseAssetReserve","internalType":"uint256"},{"type":"uint256","name":"_tradeLimitRatio","internalType":"uint256"},{"type":"uint256","name":"_fundingPeriod","internalType":"uint256"},{"type":"address","name":"_priceFeed","internalType":"contract IPriceFeed"},{"type":"bytes32","name":"_priceFeedKey","internalType":"bytes32"},{"type":"address","name":"_quoteAsset","internalType":"address"},{"type":"uint256","name":"_fluctuationLimitRatio","internalType":"uint256"},{"type":"uint256","name":"_tollRatio","internalType":"uint256"},{"type":"uint256","name":"_spreadRatio","internalType":"uint256"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"nextFundingTime","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bool","name":"","internalType":"bool"}],"name":"open","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"address"}],"name":"owner","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"contract IPriceFeed"}],"name":"priceFeed","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"bytes32","name":"","internalType":"bytes32"}],"name":"priceFeedKey","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"address","name":"","internalType":"contract IERC20"}],"name":"quoteAsset","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"quoteAssetReserve","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"renounceOwnership","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"tuple","name":"quoteAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"baseAssetReserve","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"uint256","name":"timestamp","internalType":"uint256"},{"type":"uint256","name":"blockNumber","internalType":"uint256"}],"name":"reserveSnapshots","inputs":[{"type":"uint256","name":"","internalType":"uint256"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setCap","inputs":[{"type":"tuple","name":"_maxHoldingBaseAsset","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_openInterestNotionalCap","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setCounterParty","inputs":[{"type":"address","name":"_counterParty","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setFluctuationLimitRatio","inputs":[{"type":"tuple","name":"_fluctuationLimitRatio","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setGlobalShutdown","inputs":[{"type":"address","name":"_globalShutdown","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setOpen","inputs":[{"type":"bool","name":"_open","internalType":"bool"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setOwner","inputs":[{"type":"address","name":"newOwner","internalType":"address"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setSpotPriceTwapInterval","inputs":[{"type":"uint256","name":"_interval","internalType":"uint256"}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setSpreadRatio","inputs":[{"type":"tuple","name":"_spreadRatio","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"setTollRatio","inputs":[{"type":"tuple","name":"_tollRatio","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[{"type":"tuple","name":"","internalType":"struct SignedDecimal.signedDecimal","components":[{"type":"int256","name":"d","internalType":"int256"}]}],"name":"settleFunding","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"shutdown","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"","internalType":"uint256"}],"name":"spotPriceTwapInterval","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"spreadRatio","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"swapInput","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_quoteAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_baseAssetAmountLimit","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}]},{"type":"function","stateMutability":"nonpayable","outputs":[{"type":"tuple","name":"","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]}],"name":"swapOutput","inputs":[{"type":"uint8","name":"_dir","internalType":"enum IAmm.Dir"},{"type":"tuple","name":"_baseAssetAmount","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"tuple","name":"_quoteAssetAmountLimit","internalType":"struct Decimal.decimal","components":[{"type":"uint256","name":"d","internalType":"uint256"}]},{"type":"bool","name":"_skipFluctuationCheck","internalType":"bool"}]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"tollAmount","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"tollRatio","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"int256","name":"d","internalType":"int256"}],"name":"totalPositionSize","inputs":[]},{"type":"function","stateMutability":"view","outputs":[{"type":"uint256","name":"d","internalType":"uint256"}],"name":"tradeLimitRatio","inputs":[]},{"type":"function","stateMutability":"nonpayable","outputs":[],"name":"updateOwner","inputs":[]}]

  const owner = '0xCaD18E65F91471C533ee86b76BCe463978f593AA'
  // xDaiUrl = "https://rpc.xdaichain.com/"
  const xDaiUrl = "https://dai.poa.network/"

  const provider = new ethers.providers.JsonRpcProvider(xDaiUrl)
  const wallet = new ethers.Wallet('3e730129b3867804afd27b530749d49113164a349b05879f536b6d4fe9018a9f').connect(provider)

  const LOB_address = '0x41F07A372c68B37D2b7741fCD5F3CD650Ef254b9'
  const SWF_address = '0x341a0cE2A6519Db17C33F71920200072E858F0E7'

  const CH_address = '0x5d9593586b4B5edBd23E7Eba8d88FD8F09D83EBd'
  const BTC_AMM = '0x0f346e19F01471C02485DF1758cfd3d624E399B4'
  const SNX_AMM = '0xb397389B61cbF3920d297b4ea1847996eb2ac8E8'

  const LOB = new ethers.Contract(LOB_address, LOB_abi, wallet)
  const SWF = new ethers.Contract(SWF_address, SWF_abi, wallet)
  const BTC = new ethers.Contract(BTC_AMM, AMM_abi, wallet)
  const SNX = new ethers.Contract(SNX_AMM, AMM_abi, wallet)


//await SWF.spawn()
//await LOB.setFactory(SWF_address)


  var proxy_address = await SWF.getSmartWallet(owner)
  const proxy = new ethers.Contract(proxy_address, SW_abi, wallet)
  console.log('Proxy: ',proxy_address)
  const CHencode = new ethers.utils.Interface(CH_abi)
  const CH = new ethers.Contract(CH_address, CH_abi, wallet)

/*
var createLimitOrder = await LOB.addLimitOrder(
    SNX_AMM,
    {d: ethers.utils.parseUnits('30', 18)},   //LIMIT PRICE, 30
    {d: ethers.utils.parseUnits('1', 15)},      //POS SIZE, 0.001
    {d: ethers.utils.parseUnits('30', 15)}     //COLLATERAL 0.0040
  )
  var CLO = await createLimitOrder.wait()
  console.log(CLO.transactionHash)

console.log(await LOB.getLimitOrderPrices(0))
console.log(await LOB.getLimitOrderParams(0))
*/

var ex = await LOB.execute(0, {gasLimit: 1000000})
console.log(await ex.wait())


/*
console.log(
  (await SNX.getOutputPrice(1, {d: ethers.utils.parseUnits('1', 15)})).toString()
)*/

  /*
  var func = CHencode.encodeFunctionData('openPosition(address,uint8,(uint256),(uint256),(uint256))',
  [BTC_AMM,
  1,
  {d: ethers.utils.parseUnits('1', 16)}, //margin in cents
  {d: ethers.utils.parseUnits('1', 18)}, //leverage
  {d: 0}])
  console.log(func)
  var tx = await proxy.executeCall(CH_address, func)
  var logs = await tx.wait()
  console.log('Transaction mined at ', logs.transactionHash)
*/
//console.log(CHencode)
/*
var func = CHencode.encodeFunctionData('closePosition(address,(uint256))',
[BTC_AMM,
{d: 0}])
console.log(func)
*/
//var tx = await proxy.executeCall(CH_address, func)
//var logs = await tx.wait()
//console.log('Transaction mined at ', logs.transactionHash)
/*
var price = await BTC.getOutputPrice(0, {d: ethers.utils.parseUnits('1',18)})
console.log(ethers.utils.formatUnits(price.d))

price = await BTC.getOutputPrice(1, {d: ethers.utils.parseUnits('1',18)})
console.log(ethers.utils.formatUnits(price.d))
*/
  var position = await CH.getPosition(
    SNX_AMM,
    proxy_address
  )

  function truncate(str, maxDecimalDigits) {
      if (str.includes('.')) {
          const parts = str.split('.');
          return parts[0] + '.' + parts[1].slice(0, maxDecimalDigits);
      }
      return str;
  }

  var position2 = await CH.getPositionNotionalAndUnrealizedPnl(
    SNX_AMM, proxy_address, 0
  )
  console.log('Position size: %s SNX ', truncate(ethers.utils.formatUnits(position.size.d),15))
  console.log('Margin: ', truncate(ethers.utils.formatUnits(position.margin.d),2))
  console.log('Open Notional: ', truncate(ethers.utils.formatUnits(position.openNotional.d),2))
  console.log('Unrealised PnL: ', truncate(ethers.utils.formatUnits(position2.unrealizedPnl.d),2))

}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
